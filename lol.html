<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTIMATE JSON Viewer</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --panel-bg: #ffffff;
            --text-color: #333;
            --border-color: #e1e4e8;
            --toolbar-bg: #24292e;
            --toolbar-text: #fff;
            --highlight-bg: #fffbdd;
            --match-highlight: #ffdf5d;
            --current-match: #ff9900;
            
            /* Syntax Colors */
            --key-col: #0451a5;
            --str-col: #a31515;
            --num-col: #098658;
            --bool-col: #0000ff;
            --null-col: #808080;
        }

        .dark-mode {
            --bg-color: #1e1e1e;
            --panel-bg: #252526;
            --text-color: #d4d4d4;
            --border-color: #3e3e42;
            --toolbar-bg: #333333;
            --highlight-bg: #3e3e42;
            
            /* Dark Syntax Colors */
            --key-col: #9cdcfe;
            --str-col: #ce9178;
            --num-col: #b5cea8;
            --bool-col: #569cd6;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- Toolbar --- */
        header {
            background: var(--toolbar-bg);
            color: var(--toolbar-text);
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .logo { font-weight: bold; font-size: 1.1rem; letter-spacing: 1px; }
        
        .tools { display: flex; gap: 8px; align-items: center; }

        button, .btn-label {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 3px;
            font-family: inherit;
            transition: 0.2s;
        }

        button:hover, .btn-label:hover { background: rgba(255,255,255,0.2); }
        input[type="file"] { display: none; }

        /* --- Search Bar --- */
        .search-container {
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.9);
            border-radius: 4px;
            padding: 2px;
            margin-right: 10px;
        }
        .search-input {
            border: none;
            padding: 5px;
            font-size: 0.85rem;
            width: 150px;
            background: transparent;
        }
        .search-btn {
            background: transparent;
            border: none;
            color: #333;
            font-weight: bold;
            padding: 2px 8px;
        }
        .search-btn:hover { background: #ddd; color: #000; }

        /* --- Main Layout --- */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            position: relative;
            min-width: 0;
        }
        
        .pane:last-child { border-right: none; }

        .pane-label {
            background: var(--bg-color);
            padding: 5px 10px;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #888;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        textarea {
            flex: 1;
            background: var(--panel-bg);
            color: var(--text-color);
            border: none;
            resize: none;
            padding: 15px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
        }

        /* --- Tree View --- */
        #tree-view {
            flex: 1;
            overflow: auto;
            padding: 15px;
            background: var(--panel-bg);
        }

        ul.json-tree {
            list-style: none;
            padding-left: 20px;
            margin: 0;
        }
        
        ul.json-tree li {
            position: relative;
            line-height: 1.6;
            white-space: nowrap;
        }

        /* Tree Toggles */
        .collapsible > .key-wrapper { cursor: pointer; }
        .collapsible > .key-wrapper::before {
            content: 'â–¼';
            display: inline-block;
            font-size: 0.7em;
            width: 15px;
            color: #888;
            transition: transform 0.15s;
        }
        .collapsed > .key-wrapper::before { transform: rotate(-90deg); }
        .collapsed > ul { display: none; }

        /* Syntax Highlighting */
        .key { color: var(--key-col); font-weight: 600; cursor: pointer; }
        .string { color: var(--str-col); cursor: text; }
        .number { color: var(--num-col); }
        .boolean { color: var(--bool-col); }
        .null { color: var(--null-col); }
        .meta { color: #888; font-size: 0.8em; margin-left: 5px; }

        .key:hover { text-decoration: underline; }

        /* Search Highlights */
        .highlight-match { background-color: var(--match-highlight); color: #000; border-radius: 2px; }
        .current-match { background-color: var(--current-match); color: #000; }

        /* Notification / Toast */
        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }

        /* Footer Status */
        footer {
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
            padding: 3px 15px;
            font-size: 0.75rem;
            color: #888;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">âš¡ JSON MASTER</div>
    
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search keys or values...">
        <button class="search-btn" id="search-prev">â–²</button>
        <button class="search-btn" id="search-next">â–¼</button>
        <span id="search-count" style="color:black; font-size:0.7rem; margin-right:5px; margin-left:5px;"></span>
    </div>

    <div class="tools">
        <label for="file-upload" class="btn-label" title="Upload JSON File">ðŸ“‚ Load</label>
        <input type="file" id="file-upload" accept=".json,.txt">
        
        <button onclick="formatJson()" title="Format and Build Tree">Format</button>
        <button onclick="minifyJson()" title="Compact JSON">Minify</button>
        
        <div style="width:1px; height:20px; background:#555; margin:0 5px;"></div>
        
        <button onclick="expandAll()" title="Expand All Nodes">âž• All</button>
        <button onclick="collapseAll()" title="Collapse All Nodes">âž– All</button>
        <button onclick="toggleTheme()" title="Toggle Dark/Light Mode">ðŸŒ—</button>
    </div>
</header>

<main>
    <!-- Left Pane: Input -->
    <div class="pane">
        <div class="pane-label">
            <span>Raw JSON Input</span>
            <span style="font-size: 0.7em; cursor:pointer;" onclick="document.getElementById('json-input').value=''">[Clear]</span>
        </div>
        <textarea id="json-input" placeholder="Paste JSON here or drag & drop a file..."></textarea>
    </div>

    <!-- Right Pane: Tree -->
    <div class="pane">
        <div class="pane-label">
            <span>Interactive Tree</span>
            <span id="path-display" style="color:var(--accent-color);"></span>
        </div>
        <div id="tree-view"></div>
    </div>
</main>

<footer>
    <span id="status-msg">Ready</span>
    <span id="node-count">Nodes: 0</span>
</footer>

<div id="toast">Copied to clipboard!</div>

<script>
    // --- State & Elements ---
    const dom = {
        input: document.getElementById('json-input'),
        tree: document.getElementById('tree-view'),
        search: document.getElementById('search-input'),
        countLabel: document.getElementById('search-count'),
        status: document.getElementById('status-msg'),
        nodes: document.getElementById('node-count'),
        toast: document.getElementById('toast')
    };

    let searchResults = [];
    let currentSearchIndex = -1;

    // --- Core Functions ---

    function getJsonData() {
        const raw = dom.input.value.trim();
        if (!raw) return null;
        try {
            const data = JSON.parse(raw);
            updateStatus("JSON Valid", false);
            return data;
        } catch (e) {
            updateStatus("Syntax Error: " + e.message, true);
            return null;
        }
    }

    function formatJson() {
        const data = getJsonData();
        if (!data) return;
        
        // 1. Pretty print text area
        dom.input.value = JSON.stringify(data, null, 4);
        
        // 2. Build Tree
        dom.tree.innerHTML = '';
        dom.tree.appendChild(buildTree(data, 'root')); // Start with 'root' as base path
        
        // 3. Stats
        countNodes(data);
    }

    function minifyJson() {
        const data = getJsonData();
        if(data) dom.input.value = JSON.stringify(data);
    }

    function updateStatus(msg, isError) {
        dom.status.textContent = msg;
        dom.status.style.color = isError ? 'red' : 'inherit';
    }

    // --- Tree Builder (Recursive with Path Tracking) ---

    function buildTree(data, path) {
        const type = getType(data);
        
        if (type !== 'object' && type !== 'array') {
            return createLeaf(data, type, path);
        }

        const isArray = type === 'array';
        const container = document.createElement('ul');
        container.className = 'json-tree';

        const keys = Object.keys(data);
        
        keys.forEach((key, index) => {
            const li = document.createElement('li');
            const value = data[key];
            const valueType = getType(value);
            
            // Determine Path: if array, use [index], else use .key
            const currentPath = isArray 
                ? `${path}[${key}]` 
                : `${path}.${key}`; // Note: Simple dot notation for logic, improved later for weird keys

            const keyWrapper = document.createElement('span');
            keyWrapper.className = 'key-wrapper';
            
            // Key Visual
            if (!isArray) {
                const keySpan = document.createElement('span');
                keySpan.className = 'key';
                keySpan.textContent = `"${key}"`;
                keySpan.title = "Click to copy path: " + currentPath;
                keySpan.onclick = (e) => {
                    e.stopPropagation();
                    copyToClipboard(currentPath);
                };
                keyWrapper.appendChild(keySpan);
                keyWrapper.appendChild(document.createTextNode(': '));
            } else {
                // Array index markers (optional, helpful for debugging)
                const idxSpan = document.createElement('span');
                idxSpan.className = 'meta';
                idxSpan.style.marginLeft = '0';
                idxSpan.style.marginRight = '5px';
                idxSpan.textContent = `[${key}]`;
                keyWrapper.appendChild(idxSpan);
            }

            li.appendChild(keyWrapper);

            if (valueType === 'object' || valueType === 'array') {
                li.classList.add('collapsible');
                
                // Meta info (e.g. "Array[5]")
                const size = Array.isArray(value) ? value.length : Object.keys(value).length;
                const meta = document.createElement('span');
                meta.className = 'meta';
                meta.textContent = valueType === 'array' ? `Array[${size}]` : `Object{${size}}`;
                keyWrapper.appendChild(meta);

                const childUl = buildTree(value, currentPath);
                li.appendChild(childUl);

                // Toggle click
                keyWrapper.addEventListener('click', (e) => {
                    // Prevent triggering if clicked on the key text itself (handled above)
                    // But allow clicking the arrow/wrapper
                    if(e.target.classList.contains('key')) return;
                    li.classList.toggle('collapsed');
                });
            } else {
                li.appendChild(createLeaf(value, valueType, currentPath));
            }

            container.appendChild(li);
        });

        return container;
    }

    function createLeaf(val, type, path) {
        const span = document.createElement('span');
        span.className = type;
        
        if (type === 'string') span.textContent = `"${val}"`;
        else span.textContent = val;

        span.title = "Click to copy value";
        span.onclick = (e) => {
            e.stopPropagation();
            copyToClipboard(val);
        };
        
        return span;
    }

    function getType(val) {
        if (val === null) return 'null';
        if (Array.isArray(val)) return 'array';
        return typeof val;
    }

    // --- Search Functionality ---

    dom.search.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') highlightNext();
        else runSearch();
    });
    
    document.getElementById('search-next').onclick = highlightNext;
    document.getElementById('search-prev').onclick = highlightPrev;

    function runSearch() {
        const query = dom.search.value.toLowerCase();
        
        // Remove old highlights
        document.querySelectorAll('.highlight-match').forEach(el => {
            el.classList.remove('highlight-match', 'current-match');
        });
        
        if (!query) {
            searchResults = [];
            dom.countLabel.textContent = "";
            return;
        }

        // Find matches (Keys and Values)
        // We look at .key, .string, .number, .boolean
        const targets = dom.tree.querySelectorAll('.key, .string, .number, .boolean');
        searchResults = [];

        targets.forEach(el => {
            if (el.textContent.toLowerCase().includes(query)) {
                el.classList.add('highlight-match');
                searchResults.push(el);
                
                // Expand parents so match is visible
                let parent = el.closest('.collapsible');
                while (parent) {
                    parent.classList.remove('collapsed');
                    parent = parent.parentElement.closest('.collapsible');
                }
            }
        });

        dom.countLabel.textContent = searchResults.length > 0 ? `Found ${searchResults.length}` : "No matches";
        currentSearchIndex = -1;
        if(searchResults.length > 0) highlightNext();
    }

    function highlightNext() {
        if (searchResults.length === 0) return;
        // Remove current highlight from old one
        if (currentSearchIndex >= 0) searchResults[currentSearchIndex].classList.remove('current-match');
        
        currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
        focusMatch();
    }

    function highlightPrev() {
        if (searchResults.length === 0) return;
        if (currentSearchIndex >= 0) searchResults[currentSearchIndex].classList.remove('current-match');
        
        currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
        focusMatch();
    }

    function focusMatch() {
        const el = searchResults[currentSearchIndex];
        el.classList.add('current-match');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        dom.countLabel.textContent = `${currentSearchIndex + 1} / ${searchResults.length}`;
    }


    // --- Advanced Tools ---

    function expandAll() {
        document.querySelectorAll('.collapsible').forEach(el => el.classList.remove('collapsed'));
    }

    function collapseAll() {
        document.querySelectorAll('.collapsible').forEach(el => el.classList.add('collapsed'));
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`Copied: ${text.toString().substring(0, 30)}...`);
        });
    }

    function showToast(msg) {
        dom.toast.textContent = msg;
        dom.toast.style.opacity = '1';
        setTimeout(() => dom.toast.style.opacity = '0', 2000);
    }

    function countNodes(data) {
        let count = 0;
        function traverse(obj) {
            count++;
            if (typeof obj === 'object' && obj !== null) {
                Object.values(obj).forEach(traverse);
            }
        }
        traverse(data);
        dom.nodes.textContent = `Nodes: ${count} | Size: ${new Blob([JSON.stringify(data)]).size} bytes`;
    }

    // --- File & Drag/Drop Handling ---
    
    const reader = new FileReader();
    reader.onload = (e) => {
        dom.input.value = e.target.result;
        formatJson();
    };

    document.getElementById('file-upload').addEventListener('change', (e) => {
        if (e.target.files[0]) reader.readAsText(e.target.files[0]);
    });

    // Drag Drop
    document.body.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
    document.body.addEventListener('drop', e => {
        e.preventDefault();
        if (e.dataTransfer.files[0]) reader.readAsText(e.dataTransfer.files[0]);
    });

    // Init
    window.addEventListener('DOMContentLoaded', () => {
        // Sample Data
        const sample = {
            "app": "Ultimate JSON Viewer",
            "version": 2.0,
            "features": {
                "viewing": ["Tree", "Raw"],
                "editing": true,
                "search": "Deep search with navigation"
            },
            "users": [
                { "id": 1, "name": "Alice", "roles": ["admin", "editor"] },
                { "id": 2, "name": "Bob", "active": false }
            ]
        };
        dom.input.value = JSON.stringify(sample, null, 4);
        formatJson();
    });

</script>

</body>
</html>